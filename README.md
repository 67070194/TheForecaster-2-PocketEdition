# The Forecaster 2 – Pocket Edition (IoT Environmental Dashboard)

????????????????????????????/??????????????????????? ??????????

- ????????????????? ESP32-S3 + ????????: SHT31 (????????/????????), BMP280 (???????????), PMS7003 (???? PM1/2.5/10)
- ?????? OLED SH1106 128×64, RTC DS3231, ?? LED 3 ??, ???????????? ????????????????????????????????
- ????????????? MQTT (??????????? HiveMQ public broker) ????????????????? ??????????? TimescaleDB ??????????????? Node.js
- ???????????????? OTA ???? URL ??? (???????? MQTT/????????)


## ?????????????

- ???????????????????????????: ????????, ????????, ???????????, PM1/PM2.5/PM10 ???????? AQI
- ?????? OLED ???????????????????????????, ?? LED ????????? AQI (?????/??????/???)
- ??????? Wi-Fi ???????? AP Portal (Captive Portal) ?????????? ~5 ?????? ????????????????????
- OTA Firmware: ?????????? ~10 ?????? ??????????????????????? MQTT ???????????????????
- ??????? Vite + React + Tailwind (shadcn/ui) ?????????????? Node.js ?????? REST API ??????????????? MQTT
- ?????????? Docker Compose: TimescaleDB, Server, Web ????????? Backup ?????????
- ?????? Retention DB (TimescaleDB) ?????????????????? 8 ??????? (???????????)


## ?????????????????

- `website/` – ???????????? (Vite + React + TypeScript + Tailwind + shadcn/ui)
- `server/` – ??????????? Node.js (Express + MQTT ingest + REST API)
- `microcontroller/` – ?????????????? ESP32-S3 (`ESP32-S3_CODE.ino`)
- `db/init/` – ?????????????? TimescaleDB ???????? (`01_init.sql`)
- `docker-compose.yml` – ??????????????????? (DB, Server, Web, Backup)
- `.env` – ???????????????????????? docker compose (??????????????????)


## ???????????????????? (Docker)

?????????????????: ??????? Docker Desktop (???? Docker + Compose)

1) ???????? `.env` (???????????????????? HiveMQ public broker ??? DB ????? compose)
2) ????????

   ?????????????? (Command Prompt):

   ```cmd
   ren .env.example .env
   # ??????????????????????
   copy .env.example .env
   ```

   ????????: ?????????? `.env` ??????? ???????? `docker compose up -d` ????????????? `env file ... .env not found`

???????? Windows (cmd)
- ????????? : ????????? `docker-start.cmd` ?????????????????? docker
- ???????? : ????????? `docker-stop.cmd` ?????????????????
- ??????????????? : ????????? `reset.cmd` ????????????????????

???????????????? start/stop/reset
- `start`
  - ????? `docker compose up -d`
  - ?????????????????????? 1–2 ????????????????
  - ????????????????????? `http://localhost:8080` ??? `http://<IP-???????>:8080`
  - ????? Command Prompt (cmd) ????????????????????????????
  - ???????? Docker Desktop ??? Running ????????? `.env` ????
  - ??????:
    ```cmd
    docker-start.cmd
    ```
- `stop`
  - ????? `docker compose down` ????????????????????
  - ??????:
    ```cmd
    docker-stop.cmd
    ```
- `reset`
  - Remove volumes `docker compose down -v` ????????????????????
  - ??????:
    ```cmd
    reset.cmd
    ```

?????????????????????? UI
- ??????????? http://<IP-???????>:8080 ??? http://localhost:8080
- ?????????? Firmware ???????????????? IP ???????? OTA URL ???????????????????????????
  

3) ???????? UI: http://localhost:8080
4) ?????????? API: http://localhost:3001/health

???????????????????????: ?????????????? MQTT ??????? (`wss://broker.hivemq.com:8884/mqtt`) ???????????????????????? ??????????????? broker ??????????????????????/?????????? `.env` ???????????????


## ????????????????????? (website/)

- ???????????????, ?????????????????, ???? ????????????????? (???????? RTC, ?????????????????, ???????????????? OTA)
- ?? Tester Mode ??????????? UI ??????????????? MQTT
- ????????????????? presence ???? MQTT ??? `TFCT_2_PE/web/status` ???? `online/offline` ??????????????????????????????????????? (?????????????/???????)

????????????????? (????????? docker):

```cmd
cd website
npm install
npm run dev
# ???? http://localhost:8080 (?? proxy /api ????? server:3001)
```

OTA ???????? (???? dev/docker):
- ??????????????????? `.bin` ?????? Dashboard -> ???????????????????????????????? (dev: Vite uploader, prod: server `/fw/upload`)
- ????????? URL ??????????????? MQTT `TFCT_2_PE/cmd/ota_now` (?????????????????? `TFCT_2_PE/cmd/<id>/ota_now`)
- ???????????????????????????? OTA ???????????? (?? toast ???????????????/???????)

??????????? OTA:
- ??????? `localhost`/`127.0.0.1` ?? URL ?????????????????? ?????????????????? IP LAN ?????????????????????? ????? production ?????? host ????????????????????????


## ??????????????????????? (server/ + db/)

??????????? Node.js (`server/index.js`):
- ????????? MQTT (????????????? HiveMQ) ??? subscribe `TFCT_2_PE/#`
- ?????????????????? `TFCT_2_PE/data` ???? `TFCT_2_PE/data/<id>` (payload ???? JSON)
- ???????? TimescaleDB ????? `readings` (?????????????????? `devices`)
- REST API:
  - `GET /api/latest?mac=<mac>` ??????????????????????
  - `GET /api/readings?minutes=60&mac=<mac>` ???? `?from=..&to=..` ???????????
  - `GET /health` ????????????????/DB
- ??????????????????????????????: `GET /fw/f/:file` ?????????? `POST /fw/upload`

????????? TimescaleDB (`db/init/01_init.sql`):
- ????? `devices` (??????????????) ??? `readings` (???????????? + AQI)
- ??????????? hypertable ????? retention 8 ??????? (????????? SQL)

????????????????????? (????????? `.env`):
- `MQTT_URL`, `MQTT_USERNAME`, `MQTT_PASSWORD`, `BASE_TOPIC` (??????????? `TFCT_2_PE`)
- `DATABASE_URL` (????????? Postgres/TimescaleDB)
- `UPLOADS_DIR`, `STATIC_DIR`

???????????????? (Docker):

```sh
docker compose up -d          # ????????????
docker compose logs -f server # ?? log ???????????
docker compose down           # ??????????
docker compose down -v        # ?????? DB (?? volume) – ???????
```


## ?????????? ESP32-S3 (microcontroller/ESP32-S3_CODE.ino)

???????????????:
- ESP32-S3
- SHT31 (I2C 0x44) – ????????/????????
- BMP280 (I2C 0x76 ???? 0x77) – ???????????
- PMS7003 (UART) – ???? PM1/PM2.5/PM10
- RTC DS3231 – ????
- OLED SH1106 128×64 (I2C 0x3C)
- ?????? 1 ????, LED 3 ?? (???/??????/?????)
- ?????????????????????? ADC

???????? (?????????????????):
- I2C: `SDA=8`, `SCL=9`, OLED ??? `0x3C`
- PMS7003: `RX=17`, `TX=18`
- ????: `BTN_WAKE=5` (Pull-up, ???? LOW)
- LED: `LED_GREEN=10`, `LED_YELLOW=11`, `LED_RED=12`
- ?????????: `PIN_VBAT=4` (ADC 11 dB, divider ~×5)

?????????????:
- ??????: ??????????/?????????? (AQI, Temp, Humidity, Pressure, PM1, PM2.5, PM10)
- ?????? = 5 ??????: ??????????????? Wi-Fi (AP Portal)
- ?????? = 10 ??????: ????? OTA ?????????? (???? URL ??????????????????????????????)

??????????? Wi-Fi (AP Portal):
- ??????????? AP ???? `TFCT_2_PE-XXXX` (XXXX = 4 ?????????? MAC) ?????????????????? SSID/Password
- ????????????????? ?????????????????????????????? NVS

MQTT (???????????):
- ?????????: `broker.hivemq.com:1883`
- ??????????? (LWT): `TFCT_2_PE/status` ????????????????/???????
- Presence ???????: `TFCT_2_PE/web/status` (retained: `online`/`offline`) – ?????????????????????????????????????
- ???????????????: `TFCT_2_PE/data/<id>` ??? `<id>` = `TFCT_2_PE-<mac12>`
  - Payload (????????):
    ```json
    {
      "id": "TFCT_2_PE-1a2b3c4d5e6f",
      "fw": "1.0.0",
      "aqi": 42,
      "t": 27.35,
      "h": 61.20,
      "p": 1012.45,
      "vbat": 3.9,
      "pm1": 5,
      "pm25": 12,
      "pm10": 18
    }
    ```
- ???????????????:
  - `TFCT_2_PE/cmd/time` – ???????? Epoch (??????, UTC + offset ????????????)
  - `TFCT_2_PE/cmd/interval` – ??????????????????? (???????????, 500..600000)
  - `TFCT_2_PE/cmd/ota_url` – ?????? URL ??????????
  - `TFCT_2_PE/cmd/ota_now` – ????? OTA; ???????????? `http(s)://...` ???? `host:port/path.bin` ???? `.../start`
  - ????????????????: `TFCT_2_PE/cmd/<id>/ota_url`, `TFCT_2_PE/cmd/<id>/ota_now`

????????:
- ??????????????? `online` ??? retained ??? re-assert ????????????????? retained ??????
- ?????? watchdog ?????? PMS7003 (wake/active/reinit) ???????????????
- ?????????? ~3.30V: ???????????????????????? (deep sleep)

??????????/??????? (Arduino IDE 2.x ?????):
- ??????????????????? Espressif Arduino (ESP32) ?????????? ????????????? “ESP32S3 Dev Module”
- ?????????????: `Adafruit SHT31`, `Adafruit BMP280`, `Adafruit GFX`, `Adafruit SH110X`, `RTClib`, `PubSubClient` (?????? ESP32 ???? `Preferences`, `DNSServer`, `ESPmDNS`, `HTTPClient`, `Update`)
- Serial Monitor 115200 bps
- ???????????????? PMS7003 ??????? (????? 5V)


## ?????????? MQTT/????????????????

?????? Dashboard:
- Sync ???? RTC: ??? Epoch ?? `TFCT_2_PE/cmd/time`
- ?????????????????: ???????????????? `TFCT_2_PE/cmd/interval` (?? Clamp 500..600000)
- OTA: ??????? `.bin` -> ????????? URL ?? `.../cmd/ota_now` (?????????????????????????????)


## ????????????????????????? (?????? Docker)

??????????????:
```cmd
cd server
npm install
npm run dev
# ???????????: PORT=3001, MQTT_URL=wss://broker.hivemq.com:8884/mqtt
```

???????:
```cmd
cd website
npm install
set API_PROXY_TARGET=http://localhost:3001
npm run dev
# ???? http://localhost:8080
```


## ??????????/???????????

- HiveMQ public broker ??????????? ?????????????????? ??????????? broker ????????? `.env` ???????????????????
- OTA ???? HTTP/HTTPS: ??????? URL ???????????????????????????????????????? ?????????? `localhost`/loopback
- ???????????????? TimescaleDB ?????????????????? 8 ??????? ??????????/??????????????? ?????????????????


## License

?????????????????????????? ??????????????? ????????????????????????????



